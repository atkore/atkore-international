// Copyright 2012 Google Inc.
/**
 * @author Chris Broadfoot (Google)
 * @fileoverview
 * An info panel, which complements the map view of the Store Locator.
 * Provides a list of stores, location search, feature filter, and directions.
 *//**
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * An info panel, to complement the map view.
 * Provides a list of stores, location search, feature filter, and directions.
 * @example <pre>
 * var container = document.getElementById('panel');
 * var panel = new storeLocator.Panel(container, {
 *   view: view,
 *   locationSearchLabel: 'Location:'
 * });
 * google.maps.event.addListener(panel, 'geocode', function(result) {
 *   geocodeMarker.setPosition(result.geometry.location);
 * });
 * </pre>
 * @extends {google.maps.MVCObject}
 * @param {!Node} el the element to contain this panel.
 * @param {storeLocator.PanelOptions} opt_options
 * @constructor
 * @implements storeLocator_Panel
 */storeLocator.Panel=function(e,t){this.el_=$(e);this.el_.addClass("storelocator-panel");this.settings_=$.extend({locationSearch:!0,locationSearchLabel:"Where are you?",featureFilter:!0,directions:!0,view:null},t);this.directionsRenderer_=new google.maps.DirectionsRenderer({draggable:!0});this.directionsService_=new google.maps.DirectionsService;this.init_()};storeLocator.Panel=storeLocator.Panel;storeLocator.Panel.prototype=new google.maps.MVCObject;storeLocator.Panel.prototype.init_=function(){var e=this;this.itemCache_={};this.settings_.view&&this.set("view",this.settings_.view);this.filter_=$('<form class="storelocator-filter"/>');this.el_.append(this.filter_);if(this.settings_.locationSearch){this.locationSearch_=$('<div class="location-search"><h4>'+this.settings_.locationSearchLabel+"</h4><input></div>");this.filter_.append(this.locationSearch_);typeof google.maps.places!="undefined"?this.initAutocomplete_():this.filter_.submit(function(){e.searchPosition($("input",e.locationSearch_).val())});this.filter_.submit(function(){return!1});google.maps.event.addListener(this,"geocode",function(t){e.searchPositionTimeout_&&window.clearTimeout(e.searchPositionTimeout_);if(!t.geometry){e.searchPosition(t.name);return}this.directionsFrom_=t.geometry.location;e.directionsVisible_&&e.renderDirections_();var n=e.get("view");n.highlight(null);var r=n.getMap();if(t.geometry.viewport)r.fitBounds(t.geometry.viewport);else{r.setCenter(t.geometry.location);r.setZoom(13)}n.refreshView();e.listenForStoresUpdate_()})}if(this.settings_.featureFilter){this.featureFilter_=$('<div class="feature-filter"/>');var t=this.get("view").getFeatures().asList();for(var n=0,r=t.length;n<r;n++){var i=t[n],s=$('<input type="checkbox"/>');s.data("feature",i);$("<label/>").append(s).append(i.getDisplayName()).appendTo(this.featureFilter_)}this.filter_.append(this.featureFilter_);this.featureFilter_.find("input").change(function(){var t=$(this).data("feature");e.toggleFeatureFilter_(t);e.get("view").refreshView()})}this.storeList_=$('<ul class="store-list"/>');this.el_.append(this.storeList_);if(this.settings_.directions){this.directionsPanel_=$('<div class="directions-panel"><form><input class="directions-to"/><input type="submit" value="Find directions"/><a href="#" class="close-directions">Close</a></form><div class="rendered-directions"></div></div>');this.directionsPanel_.find(".directions-to").attr("readonly","readonly");this.directionsPanel_.hide();this.directionsVisible_=!1;this.directionsPanel_.find("form").submit(function(){e.renderDirections_();return!1});this.directionsPanel_.find(".close-directions").click(function(){e.hideDirections()});this.el_.append(this.directionsPanel_)}};storeLocator.Panel.prototype.toggleFeatureFilter_=function(e){var t=this.get("featureFilter");t.toggle(e);this.set("featureFilter",t)};storeLocator.geocoder_=new google.maps.Geocoder;storeLocator.Panel.prototype.listenForStoresUpdate_=function(){var e=this,t=this.get("view");this.storesChangedListener_&&google.maps.event.removeListener(this.storesChangedListener_);this.storesChangedListener_=google.maps.event.addListenerOnce(t,"stores_changed",function(){e.set("stores",t.get("stores"))})};storeLocator.Panel.prototype.searchPosition=function(e){var t=this,n={address:e,bounds:this.get("view").getMap().getBounds()};storeLocator.geocoder_.geocode(n,function(e,n){if(n!=google.maps.GeocoderStatus.OK)return;google.maps.event.trigger(t,"geocode",e[0])})};storeLocator.Panel.prototype.setView=function(e){this.set("view",e)};storeLocator.Panel.prototype.view_changed=function(){var e=this.get("view");this.bindTo("selectedStore",e);var t=this;this.geolocationListener_&&google.maps.event.removeListener(this.geolocationListener_);this.zoomListener_&&google.maps.event.removeListener(this.zoomListener_);this.idleListener_&&google.maps.event.removeListener(this.idleListener_);var n=e.getMap().getCenter(),r=function(){e.clearMarkers();t.listenForStoresUpdate_()};this.geolocationListener_=google.maps.event.addListener(e,"load",r);this.zoomListener_=google.maps.event.addListener(e.getMap(),"zoom_changed",r);this.idleListener_=google.maps.event.addListener(e.getMap(),"idle",function(){return t.idle_(e.getMap())});r();this.bindTo("featureFilter",e);this.autoComplete_&&this.autoComplete_.bindTo("bounds",e.getMap())};storeLocator.Panel.prototype.initAutocomplete_=function(){var e=this,t=$("input",this.locationSearch_)[0];this.autoComplete_=new google.maps.places.Autocomplete(t);this.get("view")&&this.autoComplete_.bindTo("bounds",this.get("view").getMap());google.maps.event.addListener(this.autoComplete_,"place_changed",function(){google.maps.event.trigger(e,"geocode",this.getPlace())})};storeLocator.Panel.prototype.idle_=function(e){if(!this.center_)this.center_=e.getCenter();else if(!e.getBounds().contains(this.center_)){this.center_=e.getCenter();this.listenForStoresUpdate_()}};storeLocator.Panel.NO_STORES_HTML_='<li class="no-stores">There are no stores in this area.</li>';storeLocator.Panel.NO_STORES_IN_VIEW_HTML_='<li class="no-stores">There are no stores in this area. However, stores closest to you are listed below.</li>';storeLocator.Panel.prototype.stores_changed=function(){if(!this.get("stores"))return;var e=this.get("view"),t=e&&e.getMap().getBounds(),n=this,r=this.get("stores"),i=this.get("selectedStore");this.storeList_.empty();r.length?t&&!t.contains(r[0].getLocation())&&this.storeList_.append(storeLocator.Panel.NO_STORES_IN_VIEW_HTML_):this.storeList_.append(storeLocator.Panel.NO_STORES_HTML_);var s=function(){e.highlight(this.store,!0)};for(var o=0,u=Math.min(10,r.length);o<u;o++){var a=r[o].getInfoPanelItem();a.store=r[o];i&&r[o].getId()==i.getId()&&$(a).addClass("highlighted");a.clickHandler_||(a.clickHandler_=google.maps.event.addDomListener(a,"click",s));n.storeList_.append(a)}};storeLocator.Panel.prototype.selectedStore_changed=function(){$(".highlighted",this.storeList_).removeClass("highlighted");var e=this,t=this.get("selectedStore");if(!t)return;this.directionsTo_=t;this.storeList_.find("#store-"+t.getId()).addClass("highlighted");this.settings_.directions&&this.directionsPanel_.find(".directions-to").val(t.getDetails().title);var n=e.get("view").getInfoWindow().getContent(),r=$("<a/>").text("Directions").attr("href","#").addClass("action").addClass("directions"),i=$("<a/>").text("Zoom here").attr("href","#").addClass("action").addClass("zoomhere"),s=$("<a/>").text("Street view").attr("href","#").addClass("action").addClass("streetview");r.click(function(){e.showDirections();return!1});i.click(function(){e.get("view").getMap().setOptions({center:t.getLocation(),zoom:16})});s.click(function(){var n=e.get("view").getMap().getStreetView();n.setPosition(t.getLocation());n.setVisible(!0)});$(n).append(r).append(i).append(s)};storeLocator.Panel.prototype.hideDirections=function(){this.directionsVisible_=!1;this.directionsPanel_.fadeOut();this.featureFilter_.fadeIn();this.storeList_.fadeIn();this.directionsRenderer_.setMap(null)};storeLocator.Panel.prototype.showDirections=function(){var e=this.get("selectedStore");this.featureFilter_.fadeOut();this.storeList_.fadeOut();this.directionsPanel_.find(".directions-to").val(e.getDetails().title);this.directionsPanel_.fadeIn();this.renderDirections_();this.directionsVisible_=!0};storeLocator.Panel.prototype.renderDirections_=function(){var e=this;if(!this.directionsFrom_||!this.directionsTo_)return;var t=this.directionsPanel_.find(".rendered-directions").empty();this.directionsService_.route({origin:this.directionsFrom_,destination:this.directionsTo_.getLocation(),travelMode:google.maps.DirectionsTravelMode.DRIVING},function(n,r){if(r!=google.maps.DirectionsStatus.OK)return;var i=e.directionsRenderer_;i.setPanel(t[0]);i.setMap(e.get("view").getMap());i.setDirections(n)})};storeLocator.Panel.prototype.featureFilter_changed=function(){this.listenForStoresUpdate_()};storeLocator.PanelOptions=function(){};storeLocator.prototype.locationSearch;storeLocator.PanelOptions.prototype.locationSearchLabel;storeLocator.PanelOptions.prototype.featureFilter;storeLocator.PanelOptions.prototype.directions;storeLocator.PanelOptions.prototype.view;