// Copyright 2012 Google Inc.
/**
 * @author Chris Broadfoot (Google)
 * @fileoverview
 * This library makes it easy to create a fully-featured Store Locator for
 * your business's website.
 *//**
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * Data feed that returns stores based on a given bounds and a set of features.
 * @example <pre>
 * // always returns the same stores
 * function SimpleStaticFeed(stores) {
 *   this.stores = stores;
 * }
 * SimpleStaticFeed.prototype.getStores = function(bounds, features, callback) {
 *   callback(this.stores);
 * };
 * new storeLocator.View(map, new SimpleStaticFeed());
 * </pre>
 * @interface
 */storeLocator.DataFeed=function(){};storeLocator.DataFeed=storeLocator.DataFeed;storeLocator.DataFeed.prototype.getStores=function(e,t,n){};storeLocator.View=function(e,t,n){this.map_=e;this.data_=t;this.settings_=$.extend({updateOnPan:!0,geolocation:!0,features:new storeLocator.FeatureSet},n);this.init_();google.maps.event.trigger(this,"load");this.set("featureFilter",new storeLocator.FeatureSet)};storeLocator.View=storeLocator.View;storeLocator.View.prototype=new google.maps.MVCObject;storeLocator.View.prototype.geolocate_=function(){var e=this;window.navigator&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(t){var n=new google.maps.LatLng(t.coords.latitude,t.coords.longitude);e.getMap().setCenter(n);e.getMap().setZoom(11);google.maps.event.trigger(e,"load")},undefined,{maximumAge:6e4,timeout:1e4})};storeLocator.View.prototype.init_=function(){this.settings_.geolocation&&this.geolocate_();this.markerCache_={};this.infoWindow_=new google.maps.InfoWindow;var e=this,t=this.getMap();this.set("updateOnPan",this.settings_.updateOnPan);google.maps.event.addListener(this.infoWindow_,"closeclick",function(){e.highlight(null)});google.maps.event.addListener(t,"click",function(){e.highlight(null);e.infoWindow_.close()})};storeLocator.View.prototype.updateOnPan_changed=function(){this.updateOnPanListener_&&google.maps.event.removeListener(this.updateOnPanListener_);if(this.get("updateOnPan")&&this.getMap()){var e=this,t=this.getMap();this.updateOnPanListener_=google.maps.event.addListener(t,"idle",function(){e.refreshView()})}};storeLocator.View.prototype.addStoreToMap=function(e){var t=this.getMarker(e);e.setMarker(t);var n=this;t.clickListener_=google.maps.event.addListener(t,"click",function(){n.highlight(e,!1)});t.getMap()!=this.getMap()&&t.setMap(this.getMap())};storeLocator.View.prototype.createMarker=function(e){var t={position:e.getLocation()},n=this.settings_.markerIcon;n&&(t.icon=n);return new google.maps.Marker(t)};storeLocator.View.prototype.getMarker=function(e){var t=this.markerCache_,n=e.getId();t[n]||(t[n]=this.createMarker(e));return t[n]};storeLocator.View.prototype.getInfoWindow=function(e){if(!e)return this.infoWindow_;var t=$(e.getInfoWindowContent());this.infoWindow_.setContent(t[0]);return this.infoWindow_};storeLocator.View.prototype.getFeatures=function(){return this.settings_.features};storeLocator.View.prototype.getFeatureById=function(e){if(!this.featureById_){this.featureById_={};for(var t=0,n;n=this.settings_.features[t];t++)this.featureById_[n.getId()]=n}return this.featureById_[e]};storeLocator.View.prototype.featureFilter_changed=function(){google.maps.event.trigger(this,"featureFilter_changed",this.get("featureFilter"));this.get("stores")&&this.clearMarkers()};storeLocator.View.prototype.clearMarkers=function(){for(var e in this.markerCache_){this.markerCache_[e].setMap(null);var t=this.markerCache_[e].clickListener_;t&&google.maps.event.removeListener(t)}};storeLocator.View.prototype.refreshView=function(){var e=this;this.data_.getStores(this.getMap().getBounds(),this.get("featureFilter"),function(t){var n=e.get("stores");if(n)for(var r=0,i=n.length;r<i;r++)google.maps.event.removeListener(n[r].getMarker().clickListener_);e.set("stores",t)})};storeLocator.View.prototype.stores_changed=function(){var e=this.get("stores");for(var t=0,n;n=e[t];t++)this.addStoreToMap(n)};storeLocator.View.prototype.getMap=function(){return this.map_};storeLocator.View.prototype.highlight=function(e,t){var n=this.getInfoWindow(e);if(e){var n=this.getInfoWindow(e);if(e.getMarker())n.open(this.getMap(),e.getMarker());else{n.setPosition(e.getLocation());n.open(this.getMap())}t&&this.getMap().panTo(e.getLocation());this.getMap().getStreetView().getVisible()&&this.getMap().getStreetView().setPosition(e.getLocation())}else n.close();this.set("selectedStore",e)};storeLocator.View.prototype.selectedStore_changed=function(){google.maps.event.trigger(this,"selectedStore_changed",this.get("selectedStore"))};storeLocator.ViewOptions=function(){};storeLocator.ViewOptions.prototype.updateOnPan;storeLocator.ViewOptions.prototype.geolocation;storeLocator.ViewOptions.prototype.features;storeLocator.ViewOptions.prototype.markerIcon;